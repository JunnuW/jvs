function buildSpArray(){spArra=[];var b=$("#SpStart").spinner("value"),a=$("#SpStop").spinner("value");spArra.push([stack.settings.spUnit,stack.settings.RorT,""]);for(var a=(a-b)/(spNum-1),d,c=0;c<spNum;c++){d=b+c*a;switch(stack.settings.spUnit){case "eV":d=1239.8/d;break;case "um":d=(d*=1E3).toFixed(2)}spArra.push([d,NaN,NaN])}}
function evalDif(){for(var b=0,a=0,d,c=0,f=1;f<spArra.length;f++)spArra[f][2]&&(c+=1,d=spArra[f][1]-spArra[f][2],b+=d*d,a+=Math.abs(d));return 0<c?{difAve:a/c,difVar:b/c}:{difAve:"no target",difVar:"no target"}}
function iter1(){if(spArra[0][1]&&spArra[0][2]){var b=evalDif();if(1E-4>b.difAve)return $("#tuneVar").val(b.difVar-b.difAve*b.difAve),$("#tuneDif").val(b.difAve),"Stop";for(var a=b=0;a<stackArr.length;a++)if("Yes"===stackArr[a][3]){b+=1;if(0>=stackArr[a][2])return $("#tuneVar").val("d"+a+" =0 !!"),$("#tuneDif").val("Error:"),$("#autoTune").children(".ui-button-text","span").text("AutoTune"),"Stop";stackArr[a].slice(0,5);stackArr[a].push(stackArr[a][2])}return 1>b?"Stop":"Continue"}if(!spArra[0][1])return $("#tuneVar").val("Calc.err"),
$("#tuneDif").val("Calc.err"),$("#autoTune").children(".ui-button-text","span").text("AutoTune"),"Stop";if(!spArra[0][2])return $("#tuneVar").val("Target?"),$("#tuneDif").val("Target?"),$("#autoTune").children(".ui-button-text","span").text("AutoTune"),"Stop"}
function iter2(b){if(1E-4>("AutoTune"==$("#autoTune").children(".ui-button-text","span").text()?-1:b))iterEnd();else{for(var a=evalDif(),d=1.1*a.difVar,c=0;d>a.difVar;){c+=1;d=a.difVar;for(a=0;a<stackArr.length;a++)"Yes"===stackArr[a][3]&&(stackArr[a][2]*=(100+b)/100);updRTspArra();a=evalDif();if(1E3<c)break}1E3>c&&1<c&&(b*=.5);"StopTune"==$("#autoTune").children(".ui-button-text","span").text()&&setTimeout(function(a,b){b(a)},10,b,iter3)}}
function iter3(b){if(1E-4>("AutoTune"==$("#autoTune").children(".ui-button-text","span").text()?-1:b))iterEnd();else{for(var a=evalDif(),d=1.1*a.difVar,c=0;a.difVar<d;){c+=1;d=a.difVar;for(a=0;a<stackArr.length;a++)"Yes"===stackArr[a][3]&&(stackArr[a][2]*=(100-b)/100);updRTspArra();a=evalDif();if(1E3<c)break}1001>c&&1<c&&(b*=.5);"StopTune"==$("#autoTune").children(".ui-button-text","span").text()&&setTimeout(function(a,b){b(a)},10,b,iter2)}}
function iterEnd(){for(var b=evalDif(),a=1;a<stackArr.length-1;a++)stackArr[a][2]=Math.round(1E3*stackArr[a][2])/1E3;stackArr[0][2]="bulk";stackArr[stackArr.length-1][2]="bulk";oStackTable.clear();oStackTable.rows.add(stackArr);oStackTable.draw();updRTspArra();updGraph();$("#tuneVar").val(b.difVar);$("#tuneDif").val(b.difVar-b.difAve*b.difAve);$("#autoTune").children(".ui-button-text","span").text("AutoTune")}
function revertTune(){for(var b=stackArr.length,a=0;a<b;a++)console.log(a," rev to: ",stack.Layers[a][4]),"Yes"===stackArr[a][3]&&(stackArr[a][2]=stack.Layers[a][4],stack.Layers[a][2]=stack.Layers[a][4],stackArr[a][3]="No");stackArr[0][2]="bulk";stackArr[stackArr.length-1][2]="bulk";oStackTable.clear();oStackTable.rows.add(stackArr);oStackTable.draw();updRTspArra();updGraph()}
function plotRT(b,a){if(b){var d=[],c,f;c=b[0][1]+"%";f=b[0][0];f="eV"===f?"Energy eV":"Wavelength ["+f+"]";var g;for(g=1;g<b.length;g++)d.push([b[g][0],b[g][1]]);$.plot("#placeholder"+a,[{data:d,label:c}],{xaxes:[{position:"bottom",axisLabel:f}],yaxes:[{axisLabel:c}],legend:{position:"ne"}})}}
function plotNK(b,a){if(b){var d=[],c=[],f=b[0][0],f="eV"===f?"Energy eV":"Wavelength ["+f+"]",g;for(g=1;g<b.length;g++)if(6!=a)d.push([b[g][0],b[g][1]]),c.push([b[g][0],b[g][2]]);else switch(stack.settings.spUnit){case "eV":var l;l=0<b[g][0]?1239.8/b[g][0]:NaN;f="Energy eV";d.push([l,b[g][1]]);c.push([l,b[g][2]]);break;case "um":d.push([b[g][0]/1E3,b[g][1]]);c.push([b[g][0]/1E3,b[g][2]]);f="Wavelength [um]";break;case "nm":d.push([b[g][0],b[g][1]]),c.push([b[g][0],b[g][2]]),f="Wavelength [nm]"}$.plot("#placeholder"+
a,[{data:d,label:"n"},{data:c,label:"k",yaxis:2}],{xaxes:[{position:"bottom",axisLabel:f}],yaxes:[{axisLabel:"n"},{position:"right",axisLabel:"k"}],legend:{position:"ne"}})}}
function plotRT2(b){if(b){for(var a=[],d=[],c=stack.settings.RorT+"%",f=b[0][0],f="eV"===f?"Energy eV":"Wavelength ["+f+"]",g=1;g<b.length;g++)switch(stack.settings.spUnit){case "eV":var l;l=0<b[g][0]?1239.8/b[g][0]:NaN;f="Energy eV";a.push([l,b[g][1]]);d.push([l,b[g][2]]);break;case "um":a.push([b[g][0]/1E3,b[g][1]]);d.push([b[g][0]/1E3,b[g][2]]);f="Wavelength [um]";break;case "nm":a.push([b[g][0],b[g][1]]),d.push([b[g][0],b[g][2]]),f="Wavelength [nm]"}"R%"==spArra[0][1]|"T%"==spArra[0][1]?$.plot("#placeholder6",
[{data:a,label:"Calc."+spArra[0][1]},{data:d,label:"Targ."+spArra[0][2]}],{xaxes:[{position:"bottom",axisLabel:f}],yaxes:[{axisLabel:c}],legend:{position:"ne"}}):$.plot("#placeholder6",[{data:d,label:"Targ."+spArra[0][2]}],{xaxes:[{position:"bottom",axisLabel:f}],yaxes:[{axisLabel:c}],legend:{position:"ne"}})}}
function updGraph(){if("StackRT"==$("input:radio[name=graphMode]:checked").val())plotRT2(spArra);else{var b=oStackTable.$("tr.row_selected").index();if(!(1>b)){var a=[],d=[stack.settings.spUnit,"n","k"];a.push(d);for(var c=stackArr[b][4].length,f=1;f<c;f++)d=[spArra[f][0],stackArr[b][4][f],stackArr[b][5][f]],a.push(d);plotNK(a,6)}}}function updRTspArra(){spArra[0][1]=stack.settings.RorT+"%";if(stackArr.ready)matrixMult();else for(var b=spArra.length,a=1;a<b;a++)spArra[a][1]=NaN}
function updTargSpArra(){var b=$("#stackTargs option:selected").text();if(b&&"Select:"!==b&&"List is empty"!==b)for(var b=intpolData(b,stack.Targets,1),a=0;a<b.length;a++)spArra[a][2]=b[a]}
function updNKspArra(){if(!(1>stack.Targets.length)){for(var b=stackArr.length,a=0;a<b;a++){for(var d="",c=0;c<stack.Materials.length;c++)stackArr[a][1]==stack.Materials[c].Name&&(d=stack.Materials[c].Name);if(""!=d)for(var f=stackArr.length,c=0;c<f;c++)stackArr[c]=stackArr[c].slice(0,4),stackArr[c].push([]),stackArr[c].push([]),d=intpolData(stackArr[c][1],stack.Materials,1),stackArr[c][4]=d,d=intpolData(stackArr[c][1],stack.Materials,2),stackArr[c][5]=d}for(c=0;c<f;c++)stackArr.ready=!0,stackArr.ready=
stackArr[c][4].length!==spArra.length?!1:!0;$("#setStack").is(":checked")&&updRTspArra()}}
function cubSplinInt(b,a){var d=[],c=b.length,f=Array(c),g=a.length,l=a[0][1],k;d.push(0);for(var e=2;e<g-1;e++)k=((a[e+1][1]-a[e][1])/(a[e+1][0]-a[e][0])+(a[e][1]-a[e-1][1])/(a[e][0]-a[e-1][0]))/2,d.push(k);2<=g&&d.push(0);for(e=0;e<c;e++)if(b[e]>a[g-1][0])f[e]="","T"==l|"R"==l&&(f[e]=NaN),"n"==l|"k"==l&&(f[e]=a[g-1][1]);else for(k=1;k<g-1;k++)if(b[e]<a[1][0]){f[e]="";"T"==l|"R"==l&&(f[e]=NaN);"n"==l|"k"==l&&(f[e]=a[1][1]);break}else if(b[e]==a[k][0])f[e]=a[k][1];else if(b[e]>a[k][0]&&b[e]<a[k+1][0]){var h=
(b[e]-a[k][0])/(a[k+1][0]-a[k][0]);f[e]=(2*h*h*h-3*h*h+1)*a[k][1]+(h*h*h-2*h*h+h)*d[k-1]*(a[k+1][0]-a[k][0])+(-2*h*h*h+3*h*h)*a[k+1][1]+(h*h*h-h*h)*d[k]*(a[k+1][0]-a[k][0])}return f}
function intpolData(b,a,d){for(var c=[],f,g,l=spArra.length,k=[],e=1;e<l;e++)k.push(spArra[e][0]);for(e=0;e<a.length;e++)if(b==a[e].Name){g=a[e].Data[0][d];f=a[e].Data[0][0];var l=a[e].Data.length,h=[,g];c.push(h);for(var m=1;m<l;m++)h=[],h.push(a[e].Data[m][0]),h.push(a[e].Data[m][d]),c.push(h);break}if(0===c.length)return[];a=c.length;switch(f){case "nm":break;case "um":for(e=0;e<a;e++)c[e][0]*=1E3;break;case "eV":for(e=0;e<a;e++)if(0<c[e][0])c[e][0]=1239.8/c[e][0];else{c[e][0]=NaN;console.log("spectral point at 0 (zero) energy!");
break}break;default:return alert("Unknown spectral unit in material: "+b),[]}b=[];b.push(g);c=cubSplinInt(k,c);return b=b.concat(c)}
function createStackTable(){oStackTable=$("#StackEdit").DataTable({aaData:stackArr,bPaginate:!1,bLengthChange:!0,bFilter:!1,bSort:!1,bInfo:!0,bAutoWidth:!0,aoColumns:[{sTitle:"Id:",sWidth:"7%",sType:"text",sClass:"centtis"},{sTitle:"Material:",sWidth:"43%",sType:"text",sClass:"centtis"},{sTitle:"Thickness:",sWidth:"43%",sType:"text",sClass:"centtis"},{sTitle:"Tuned:",sWidth:"7%",sType:"text",sClass:"centtis",type:"checkbox",onblur:"submit",checkbox:{trueValue:"Yes",falseValue:"No"}}]});oStackTable.clear();
oStackTable.draw()}function createMatEditTable(){var b="Unit ["+matrlArr[0][0]+"]";oMatTable=$("#matEditTabl").DataTable({bPaginate:!0,bLengthChange:!0,bFilter:!0,bSort:!1,bInfo:!0,bAutoWidth:!0,aoColumns:[{sTitle:b,sWidth:"20%",sType:"numeric",sClass:"centtis"},{sTitle:"n",sWidth:"15%",sType:"numeric",sClass:"centtis"},{sTitle:"k",sWidth:"15%",sType:"numeric",sClass:"centtis"}],bScrollCollapse:!0});oMatTable.clear();oMatTable.draw()}
function createMatOptsTable(){oMatOptTable=$("#matOpsTabl").DataTable({autoWidth:!0,bPaginate:!1,bLengthChange:!1,bFilter:!1,bSort:!1,bInfo:!1,bAutoWidth:!0,aoColumns:[{sTitle:"No:",sWidth:"4%",sType:"numeric",sClass:"centtis"},{sTitle:"Label",sWidth:"30%",sType:"text",sClass:"centtis"},{sTitle:"Unit",sWidth:"4%",sType:"text",sClass:"centtis"},{sTitle:"Count",sWidth:"4%",sType:"numeric",sClass:"centtis"},{sTitle:"Owner",sWidth:"13%",sType:"text",sClass:"centtis"},{sTitle:"File",sWidth:"45%",sType:"text",
sClass:"centtis"}],bScrollCollapse:!0});oMatOptTable.clear();oMatOptTable.draw()}function createTargEditTable(){var b="Unit: ["+targArr[0][0]+"]",a=targArr[0][1]+" %-value";otargTable=$("#targEditTabl").DataTable({bPaginate:!0,bLengthChange:!0,bFilter:!0,bSort:!1,bInfo:!0,bAutoWidth:!0,aoColumns:[{sTitle:b,sWidth:"20%",sType:"numeric",sClass:"centtis"},{sTitle:a,sWidth:"15%",sType:"numeric",sClass:"centtis"}],bScrollCollapse:!0});otargTable.clear();otargTable.draw()}
function createTargOptsTable(){oTargOptTable=$("#targOptsTabl").DataTable({autoWidth:!0,bPaginate:!1,bLengthChange:!1,bFilter:!1,bSort:!1,bInfo:!1,bAutoWidth:!0,aoColumns:[{sTitle:"No:",sWidth:"4%",sType:"numeric",sClass:"centtis"},{sTitle:"Label",sWidth:"30%",sType:"text",sClass:"centtis"},{sTitle:"Unit",sWidth:"4%",sType:"text",sClass:"centtis"},{sTitle:"Count",sWidth:"4%",sType:"numeric",sClass:"centtis"},{sTitle:"Owner",sWidth:"13%",sType:"text",sClass:"centtis"},{sTitle:"File",sWidth:"45%",sType:"text",
sClass:"centtis"}],bScrollCollapse:!0});oTargOptTable.clear();oTargOptTable.draw()}function buildStack(){return{settings:{polaris:"TE",angle:0,RorT:"R",backR:"false",frontR:"false",SubstrD:1E6,CoverD:1E6,spUnit:"nm",spStart:400,spStop:1E3,spStep:1,tunePrcnt:.5,usedTarg:"",Descriptor:""},Materials:[],Targets:[],Layers:[["Cover ","DblClick to edit!","bulk","no",0],["Substrate","DblClick to edit!","bulk","no",0]]}}
function afterStackRead(b){stack={};stack=b;stackArr=[];b=stack.Layers.length;for(var a=0;a<b;a++){if(0==a||a==b)stack.Layers[a][4]="bulk";stackArr.push(stack.Layers[a]);stack.Layers[a][4]=stack.Layers[a][2]}b=makeOptsArr(stack.Materials);oMatOptTable.clear();0<b.length&&(oMatOptTable.rows.add(b),oMatOptTable.draw());b=makeOptsArr(stack.Targets);oTargOptTable.clear();0<b.length&&(oTargOptTable.rows.add(b),oTargOptTable.draw());oStackTable.clear();oStackTable.rows.add(stackArr);oStackTable.draw();
b=stackArr.length;for(var a=!1,d=0;d<b;d++)"Yes"===stackArr[d][3]&&(a=!0);a?$("#adjustThs").show():$("#adjustThs").hide();updNKspArra();updRTspArra();StackTargSelUpd();updTargSpArra();updGraph()};
