var msgThread=$("#msgThread"),btnSaveMsg=$("#btnSaveMsg"),userMes=$("#userMes"),msgTree=$("#msgTree"),lblHeader=$("#lblHeader"),msgHeader=$("#msgHeader"),msgText=$("#msgText"),msgLbl=$("#msgLbl"),msgUser=window.sessionStorage.getItem("RTFuser"),disa=msgUser&&"Publ"==msgUser?!1:!0;msgThread.prop("disabled",disa);msgUser&&"No login"!=msgUser?(countMessages(msgUser),btnSaveMsg.attr("disabled",!1)):(btnSaveMsg.attr("disabled",!0),userMes.text(msgUser));
var bTreeData=[{text:"Root nod",children:[{text:"Child node 1"},{text:"Child node 2"}]}],mesTree=msgTree.jstree({core:{check_callback:!0,data:bTreeData}});msgTreeUpdate();
btnSaveMsg.click(function(){1>msgUser.length||"No login"==msgUser?$.notifyBar({cssClass:"error",html:"Please login for messaging "}):"Create message"==$(this).text()?(lblHeader.css("display","inline"),msgHeader.css("display","inline"),msgText.val(""),btnSaveMsg.text("Submit message"),msgLbl.text("New message:"),msgHeader.val("")):saveMessage()});
function fleNmr(){var a,b=msgHeader.val(),b=b.replace(/(^\/)|(\/$)/g,"");if(!/^[\sa-zA-Z0-9\?\!\-\_]+$/i.test(b))return alert("Invalid header in: "+b),a;var c=msgTree.jstree(!0).get_selected(!0)[0],c=makeLongName(c),c=c.replace(/(^\/)|(\/$)/g,"");return/^[\sa-zA-Z0-9\?\!\-\_\/]+$/i.test(c)?1>msgText.val().length?(alert("No message content!"),a):a=(0==b.indexOf(c)?b:c+"/"+b).replace(/(^\/)|(\/$)/g,""):(alert("Invalid thread: "+c),a)}
function msgTreeUpdate(){msgHeader.prop("disabled",!1);msgText.prop("disabled",!1);$.post("/auth/getMessages",{moderated:"all"}).done(function(a,b,c){a?(console.log("data received: ",a),200==a.statCode?(bTreeData=JSON.parse(a.resString),msgTree.jstree(!0).settings.core.data=bTreeData,msgTree.jstree(!0).refresh()):$.notifyBar({cssClass:"error",html:a.error})):(console.log("no data received"),$.notifyBar({cssClass:"error",html:"could not obtain user messages from server"}))}).fail(function(){console.log("failed to read user messages ");
$.notifyBar({cssClass:"warning",html:"(Connection or database error)"})})}
msgTree.on("change.jstree deselect_all.jstree select_node.jstree",function(a,b){switch(a.type){case "deselect_all":msgThread.val("");msgHeader.val("");$("#msgTxt").val("");break;case "select_node":btnSaveMsg.text("Create message");lblHeader.css("display","none");msgHeader.css("display","none");selctdNde=b.instance.get_selected(!0)[0];msgThread.val(selctdNde.text);for(var c=0,d=selctdNde.parent,e="#"!=d;e;){c+=1;if(20<c)break;e="";e=bTreeData.filter(function(a){return a.id==d});d=e[0].parent;e=0<e[0].parent.length&&
"#"!=e[0].parent}$.post("/auth/getOneMessage",{messageId:selctdNde.id}).done(function(a,b,d){a?(a=JSON.parse(a.resString),msgText.val(a.uMessage),msgLbl.text(a.username+" wrote on "+a.dateRec)):$.notifyBar({cssClass:"error",html:a.error})}).error(function(a,b,d){$.notifyBar({cssClass:"error",html:d})})}});
function saveMessage(){var a=fleNmr();if(a){var b=msgText.val();if(501<b.length)$.notifyBar({cssClass:"error",html:"Your message is too long"});else{var c=window.sessionStorage.getItem("RTFtoken");$.post("/auth/messageSave",{userNme:msgUser,Collection:"messages",rtftoken:c,fName:a,Text:b}).done(function(a,b,c){a?"invalid"==a.token?(window.sessionStorage.setItem("RTFuser","No login"),window.sessionStorage.setItem("RTFtoken",null),$.notifyBar({cssClass:"error",html:a.response})):200==a.statCode?($.notifyBar({cssClass:"success",
html:"Thank's! Your message was send to moderator."}),btnSaveMsg.text("Create message"),msgHeader.val(""),msgText.val(""),countMessages(msgUser)):$.notifyBar({cssClass:"error",html:a.error}):$.notifyBar({cssClass:"error",html:a.error})}).error(function(a,b,c){409==a.status?(a=JSON.parse(a.responseText),$.notifyBar({cssClass:"warning",html:a.resString})):$.notifyBar({cssClass:"warning",html:"Connection or server database eror: "+c})})}}}
function userNupdate(a){a=JSON.parse(a.MessageCount);var b="You have posted "+(a.all-a.inModeration)+" messages";0<a.inModeration&&(b=b+" + "+a.inModeration+" in moderation");userMes.text(b)}function countMessages(a){$.post("/auth/countMessages",{username:a}).done(function(a,c,d){a?userNupdate(a):(console.log("message count could not be obtained from server"),$.notifyBar({cssClass:"error",html:a.error}))}).error(function(a,c,d){$.notifyBar({cssClass:"error",html:d})})}
function makeLongName(a){var b=a.text,c=0,d=a.parent;for(a="#"!=d;a;){c+=1;if(20<c)break;a="";a=bTreeData.filter(function(a){return a.id==d});d=a[0].parent;0<d.length&&(b=a[0].text+"/"+b);a=0<a[0].parent.length&&"#"!=a[0].parent}return b};
