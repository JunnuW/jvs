$("#mongoDialForm").dialog({open:function(){"Save simulation spectrum"==$(this).dialog("option","title")?$("#saaveSim").css("display","inline"):$("#saaveSim").css("display","none");$("#frm-DirSel").show();$("#frm-Login").hide();$("#frm-FileTree").hide();$("#btn-mngOpenSave").hide();"No login"!=userName?$("#btnLogMeOff").show():$("#btnLogMeOff").hide();-1<$("#mongoDialForm").dialog("option","title").indexOf("Open")?($("#btn-mngOpenSave").text("Open File"),$("#btnPublDir").show()):($("#btn-mngOpenSave").text("Save data"),
$("#btnPublDir").hide())},autoOpen:!1,hide:{effect:"explode",duration:500},height:"auto",width:"auto",modal:!1,buttons:[{id:"btnMngoCancel",text:"Cancel","class":"medium-btn",click:function(){$("#mongoTree").jstree("deselect_all");$("#mongoTree").jstree("close_all");$("#FilTreLege").text("Files available on server:");$(this).dialog("option","title");var a=$("#radioMeas").prop("checked"),b=$("#settnDial").dialog("option","title");"Inhomogeneous spectrum"==b&&a?(inhomSpectr.experPlot=[],inhomSpectr.experArr=
[],graphSettn.inhomFileN="",$("#inhDescLbl").css("display","none"),$("#inhDesc").css("display","none"),$("#inhDesc").html(""),makeExpArrs(),inhombr()):"Homogeneous spectrum"==b&&a&&(homSpectr.experPlot=[],homSpectr.experArr=[],simSettn.fileN="",$("#homDescLbl").css("display","none"),$("#homDesc").css("display","none"),$("#homDesc").html(""),makeExpArrs(),hombr());$(this).dialog("close")}},{id:"btnLogMeOff",text:"Log me off","class":"medium-btn",click:function(){$.get("/logout");userName="No login";
window.sessionStorage.setItem("RTFuser","");window.sessionStorage.setItem("RTFtoken","");$("#frm-FileTree").hide();$("#btnLogMeOff").hide()}},{id:"btn-mngOpenSave",text:"Open File","class":"medium-btn-inline",click:function(){var a=$("#btn-mngOpenSave").text();-1<a.indexOf("Open")?(a=$("#mongoFileName").val(),mongoGetOne(a,dirUser)):operDispatcher(a)}}]});
$("#chkSavePars, #chkSaveSimu").click(function(){$("#btnUserDir").attr("disabled",!1);$("#btnLocDir").attr("disabled",!1);"chkSaveSimu"==$(this).attr("id")&&1==$(this).prop("checked")&&$("#numSel").prop("disabled",!1);"chkSavePars"==$(this).attr("id")&&1==$(this).prop("checked")&&$("#numSel").prop("disabled",!0);1==$("#chkSaveSimu").prop("checked")?($("#btnUserDir").attr("disabled",!0),$("#numSel").prop("disabled",!1)):($("#btnUserDir").attr("disabled",!1),$("#numSel").prop("disabled",!0));0==$("#chkSaveSimu").prop("checked")&&
0==$("#chkSavePars").prop("checked")&&($("#btnUserDir").attr("disabled",!0),$("#btnLocDir").attr("disabled",!0),$("#numSel").prop("disabled",!0))});
function mongoReadDesc(a,b){var d=pickCollection(),c;"No login"!=userName&&(c=window.sessionStorage.getItem("RTFtoken"));$.post("/auth/dbFindOne",{userNme:dirUser,fileName:a,rtftoken:c,Collection:d,replyType:"descOnly"}).done(function(a){a&&200==a.statCode&&(0==a.resString.indexOf("DocumentOK")?(a=a.resString.slice(a.resString.indexOf(":")+1),a=0<a.length?a:"without description",b(a)):($.notifyBar({cssClass:"warning",html:"File not found: "+a.error}),b("")))}).fail(function(a){handleFail(a.responseText,
"Description not obtained");b("")})}
function mongoSave(a,b){var d=pickCollection(),c;"No login"!=userName&&(c=window.sessionStorage.getItem("RTFtoken"));var e=DFmngo.dialog("option","title"),f={},g=$("#mongoFileName").val(),g=g.replace(/(^\/)|(\/$)/g,""),g=g.trim();if(1>g.length)f=toJsonArr(d,b,[],$("#mongFileDesc").val());else switch(g=$("#mongFileDesc").val(),e){case e.match(/material/gi)?e:void 0:f=toJsonArr(d,b,matrlArr,g);break;case e.match(/target/gi)?e:void 0:f=toJsonArr(d,b,targArr,g);break;case e.match(/Save Inhomogeneous/gi)?
e:void 0:f=toJsonArr(d,b,inhomSpectr.experArr,g);break;case e.match(/Save Homogeneous/gi)?e:void 0:f=toJsonArr(d,b,homSpectr.experArr,g);break;case e.match(/stack/gi)?e:void 0:g=g.replace(/(^[\"\']+)|([\"\']+$)/g,"");f.Filename=b;f.Descr=g;f.Stack=stack;break;case e.match(/Save simulation/gi)?e:void 0:f.Filename=b;f.Descr=g;f.Header=makeSimHeader();f.Params=JSON.stringify(simParHeader());break;default:throw"No datacollection for "+e;}$.post(a,{userNme:dirUser,Collection:d,rtftoken:c,data:JSON.stringify(f)}).done(function(a){if(a&&
200==a.statCode)if(-1<a.resString.indexOf("saving OK")||-1<a.resString.indexOf("Updated")){$("#btn-mngOpenSave").text("Save file");switch(e){case e.match(/material/gi)?e:void 0:$("#descMater").val($("#mongFileDesc").val());EnDisButt("Enabled","#btnUseMat");break;case e.match(/target/gi)?e:void 0:$("#descTarge").val($("#mongFileDesc").val());EnDisButt("Enabled","#btnUseTarg");break;case e.match(/stack/gi)?e:void 0:$("#descStack").val($("#mongFileDesc").val());break;case e.match(/Save Inhomogeneous/gi)?
e:void 0:graphSettn.inhomFileN=f.Filename;break;case e.match(/Save Homogeneous/gi)?e:void 0:graphSettn.homFileN=f.Filename;break;default:throw"No datacollection for "+e;}$.notifyBar({cssClass:"success",html:"Your data was saved to file: "+f.Filename})}else $.notifyBar({cssClass:"warning",html:"File was not saved, database error: "+a.error})}).fail(function(a){handleFail(a.responseText,"Nothing was saved")});DFmngo.dialog("close")}
function saveToMngoDb(a){var b=pickCollection();$.post("/auth/checkOneUserF",{userNme:dirUser,Collection:b,fileName:a}).done(function(d){if(d&&200==d.statCode)switch(d.resString){case "yes":$("#btn-mngOpenSave").text("Confirm Overwrite");break;case "no":mongoSave("/auth/dbInsert",a);break;default:$.notifyBar({cssClass:"error",html:"File was not saved! bad response from server!"})}else $.notifyBar({cssClass:"error",html:d?d.error:"Could not check if already file exists on server!"}),DFmngo.dialog("close")}).fail(function(){$.notifyBar({cssClass:"error",
html:"(Connection or database error in server)"});DFmngo.dialog("close")})}
function mongoGetOne(a){var b=pickCollection(),d;"No login"!=userName&&(d=window.sessionStorage.getItem("RTFtoken"));$.post("/auth/dbFindOne",{userNme:dirUser,fileName:a,rtftoken:d,Collection:b,replyType:"wholeDoc"}).done(function(c,d){if("nocontent"==d)$.notifyBar({cssClass:"warning",html:"Data could not be obtained from server: "});else if("success"==d&&c)switch(c.statCode){case 200:if(-1<c.resString.indexOf("DocumentOK")){var e=JSON.parse(c.resString.slice(c.resString.indexOf("{")));"simulparams"==
b?respToParams(a,e):"emissions"==b?respToEmis(a,e):respToArr(a,e)}break;case 202:$.notifyBar({cssClass:"warning",html:"Data could not be obtained: "+c.error})}}).fail(function(a){handleFail(a.responseText,"Data was not obtainable")});DFmngo.dialog("close")}
function mongoRename(a,b,d){var c=pickCollection(),e;"No login"!=userName&&(e=window.sessionStorage.getItem("RTFtoken"));$.post("/auth/dbRename",{userNme:dirUser,Collection:c,oldName:a,rtftoken:e,newName:b,fileType:d}).done(function(a){a&&(-1<a.resString.indexOf("renaming OK")?($("#btn-mngOpenSave").text("Save data"),$.notifyBar({cssClass:"success",html:a.resString})):$.notifyBar({cssClass:"warning",html:"File was not renamed "+a.resString}))}).fail(function(a){handleFail(a.responseText,"Renaming failed")});
DFmngo.dialog("close")}
function mongoDelete(a){var b=pickCollection(),d;"No login"!=userName&&(d=window.sessionStorage.getItem("RTFtoken"));$.post("/auth/dbDelete",{userNme:dirUser,rtftoken:d,Collection:b,fileName:a}).done(function(a){a&&200==a.statCode&&(-1<a.resString.indexOf("deleting OK")?($("#btn-mngOpenSave").text("Save data"),$.notifyBar({cssClass:"success",html:"You deleted:"+a.resString.slice(17)})):$.notifyBar({cssClass:"warning",html:"File was not deleted, database error: "+a.error}))}).fail(function(a){handleFail(a.responseText,"Nothing was deleted")});
DFmngo.dialog("close")}
function pickCollection(){var a=DFmngo.dialog("option","title");switch(a){case a.match(/material/gi)?a:void 0:a="materials";break;case a.match(/target/gi)?a:void 0:a="targets";break;case a.match(/stack/gi)?a:void 0:a="stacks";break;case a.match(/Save Inhomogeneous/gi)?a:void 0:a="emissions";break;case a.match(/Save Homogeneous/gi)?a:void 0:a="emissions";break;case a.match(/Save simulation/gi)?a:void 0:a="simulparams";break;case a.match(/Open emission/gi)?a:void 0:a="emissions";break;case a.match(/Open simulated/gi)?
a:void 0:a="simulparams";break;default:throw"No datacollection for "+a;}return a}
function treeUpdate(){$("#directoName").prop("disabled",!1);$("#mongoFileName").prop("disabled",!1);$("#mongFileDesc").prop("disabled",!1);var a=pickCollection(),b;"No login"!=userName&&(b=window.sessionStorage.getItem("RTFtoken"));$.post("/auth/checkAllUserF",{userNme:dirUser,rtftoken:b,Collection:a}).done(function(a,c,b){a?"invalid"==a.token?(userName="No login",window.sessionStorage.setItem("RTFuser",userName),window.sessionStorage.setItem("RTFtoken",null),$.notifyBar({cssClass:"error",html:a.response}),
$("#frm-Login").show(),$("#frm-FileTree").hide(),$("#btn-mngOpenSave").hide(),$("#btnLogMeOff").hide()):200==a.statCode?($("#mongoTree").jstree(!0).settings.core.data=JSON.parse(a.resString),$("#mongoTree").jstree(!0).refresh(),-1<$("#mongoDialForm").dialog("option","title").indexOf("Open")?($("#btn-mngOpenSave").text("Open File"),$("#fsFileDesc").css("display","none"),$.notifyBar({cssClass:"success",html:"select from filetree"})):($("#fsFileDesc").css("display","inline"),a="Inhomogeneous spectrum"==
$("#settnDial").dialog("option","title")?$("#inhDesc").text():$("#homDesc").text(),$("#mongFileDesc").val(a))):$.notifyBar({cssClass:"error",html:a.error}):$.notifyBar({cssClass:"error",html:"Error in username and/or password, try again or hit Cancel"})}).fail(function(){$.notifyBar({cssClass:"warning",html:"(Connection or database error in server)"})})}
$("#btnPublDir").click(function(){dirUser="Publ";$("#frm-DirSel").hide();treeUpdate();$("#FilTreLege").text("Server files in public directory");$("#frm-FileTree").show();$("#btn-mngOpenSave").show();$("#fsFileDesc").hide()});
$("#btnLocDir").click(function(){var a;switch($("#mongoDialForm").dialog("option","title")){case "Open material file from":$("#descMater").val("");$("#ediMaterLbl").text("Local file: ");$("#mongoDialForm").dialog("close");$("#matLocFiles").focus().click();break;case "Open target file from":$("#descTarge").val("");$("#ediTargeLbl").text("Local file: ");$("#mongoDialForm").dialog("close");$("#targLocFiles").focus().click();break;case "Open stack file from":$("#descStack").val("");$("#ediStackLbl").text("Local file: ");
$("#mongoDialForm").dialog("close");$("#stackLocFiles").focus().click();break;case "Open emission spectrum":$("#mongoDialForm").dialog("close");$("#emisLocFiles").focus().click();break;case "Open simulated spectrum":$("#mongoDialForm").dialog("close");$("#simLocFiles").focus().click();break;case "Save Inhomogeneous spectrum":a=graphSettn.inhomFileN;$("#settnDial").dialog("option","title");c=experEmisDat();seiv_loucal(a,c,emisToLocFile);break;case "Save Homogeneous spectrum":a=graphSettn.homFileN;
$("#settnDial").dialog("option","title");c=experEmisDat();seiv_loucal(a,c,emisToLocFile);break;case "Save simulation spectrum":c="Header:"+makeSimHeader();$("#chkSavePars").prop("checked")&&(c+="\nParameters:"+JSON.stringify(simParHeader()));$("#chkSaveSimu").prop("checked")&&(c=c+"\nResult:\n"+simulSaveDat());a=graphSettn.homFileN;seiv_loucal("Sim-"+a,c,emisToLocFile);break;case "Save material data to":a=$("#ediMater").val();a=a.slice(a.lastIndexOf("/")+1);c=matrlArr[0][0]+"\t"+matrlArr[0][1]+"\t"+
matrlArr[0][2];matrlArr[0][3]&&(c+='\t"'+matrlArr[0][3]+'"');for(var b,d=1;d<matrlArr.length;d++)b=matrlArr[d][0]+"\t"+matrlArr[d][1]+"\t"+matrlArr[d][2],c=c+"\r"+b;seiv_loucal(a,c,matrlToLocFile);break;case "Save target data to":a=$("#ediTarge").val();a=a.slice(a.lastIndexOf("/")+1);var c=targArr[0][0]+"\t"+targArr[0][1];targArr[0][2]&&(b=targArr[0][2].replace(/(^[\"\']+)|([\"\']+$)/g,""),c=c+"\t"+('"'+b+'"'));for(d=1;d<targArr.length;d++)b=targArr[d][0]+"\t"+targArr[d][1],c=c+"\r"+b;seiv_loucal(a,
c,targetToLocFile);break;case "Save stack data to":a=$("#ediStack").val(),a=a.slice(a.lastIndexOf("/")+1),c=JSON.stringify(stack),seiv_loucal(a,c,stackToLocFile)}$("#mongoDialForm").dialog("close")});
$("#btnUserDir").click(function(){$("#frm-DirSel").hide();"No login"!=userName?(dirUser=userName,$("#frm-Login").hide(),$("#frm-DirSel").hide(),treeUpdate(),$("#frm-FileTree").show(),$("#FilTreLege").text("Files on server in "+userName+"'s directory"),$("#btn-mngOpenSave").show()):(dirUser="Publ",$("#frm-Login").show(),$("#frm-FileTree").hide(),$("#btn-mngOpenSave").hide())});
$("#mongoTree").on("close_node.jstree change.jstree rename_node.jstree delete_node.jstree deselect_all.jstree select_node.jstree",function(a,b){var d;switch(a.type){case "close_node":$("#fsFileDesc").css("display","none");$(".ui-widget-content").animate({scrollTop:$("#mongoDialForm").get(0).scrollHeight},1E3);break;case "deselect_all":if(d=b.node[0])if(d=b.instance._model.data[d]){var c=d.original.text,e=d.text;e!=c&&$("#mongoTree").jstree("set_text",d,c)}break;case "select_node":d=b.instance.get_selected(!0)[0];
$("#mongoFileName").prop("disabled",!1);$("#directoName").prop("disabled",!1);e=$("#mongoDialForm").dialog("option","title");-1<e.indexOf("Open")?$("#btn-mngOpenSave").text("Open File"):$("#btn-mngOpenSave").text("Save data");$("#fsFileDesc").css("display","inline");c=mongoColle();$("#directoName").val(c.Folder);$(".ui-widget-content").animate({scrollTop:$("#mongoDialForm").get(0).scrollHeight},1E3);"jstree-file"==d.icon?($("#mongoFileName").val(c.longFile),-1<e.indexOf("Open")&&mongoReadDesc(c.longFile,
function(a){$("#mongFileDesc").val(a)})):-1<e.indexOf("Open")?($("#mongoFileName").val(""),$("#fsFileDesc").css("display","none"),$("#frm-FileTree").hide(),$("#frm-FileTree").show()):($("#mongoFileName").val(""),$("#fsFileDesc").css("display","inline"));break;case "rename_node":d=b.instance.get_selected(!0)[0];e=mongoColle();"jstree-file"==d.icon?(e=e.Folder,e=e.replace(/(^\/)|(\/$)/g,""),e=e+"/"+d.text,$("#mongoFileName").val(e),$("#btn-mngOpenSave").text("Confirm file rename")):(c=e.Folder.lastIndexOf("/"),
e=e.Folder.slice(0,c+1),e+=d.text,$("#btn-mngOpenSave").text("Confirm folder rename"),$("#directoName").val(e),$("#mongoFileName").val(""));break;case "delete_node":$("#mongoFileName").prop("disabled",!0),$("#directoName").prop("disabled",!0),d=1>$("#mongoFileName").val().length?"Confirm folder delete":"Confirm file delete",$("#btn-mngOpenSave").text(d)}});
function mongoColle(){var a=$("#mongoTree").jstree(!0),b=a.settings.core.data,d=a.get_selected(!0)[0],a={longFile:"",shortFile:"",Folder:""};if(!b||1>d.id.length)return a;for(var c="",e=$.grep(b,function(a){return a.id==d.id})[0].icon,f=!0,g=d.id,h="";f;)var k=$.grep(b,function(a){return a.id==g})[0],f="#"!=k.parent&&"ajason1"!=d.id,h=k.text,h=h.replace(/(^\/)|(\/$)/g,""),c=h+"/"+c,g=k.parent;c=c.replace(/(^\/)|(\/$)/g,"");b=c.lastIndexOf("/");a.longFile=h;"jstree-file"==e?(h=c.slice(0,b+1),a.Folder=
h.replace(/(^\/)|(\/$)/g,""),a.shortFile=c.slice(b+1),a.longFile=a.Folder+"/"+a.shortFile):(a.Folder=c,a.longFile="",a.shortFile="");return a}
function operDispatcher(a){var b=$("#mongoFileName").val(),d=$("#directoName").val();if(b=fleNamer(b,d))switch(a){case "Save data":saveToMngoDb(b);break;case "Confirm Overwrite":mongoSave("/auth/dbUpdate",b);break;case "Save Changes":saveToMngoDb(b);case "Confirm file delete":mongoDelete(b);break;case "Confirm folder delete":mongoDelete(b);break;case "Confirm file rename":var c=$("#mongoTree").jstree(!0).get_selected(!0)[0];a=mongoColle().Folder;a=a.replace(/(^\/)|(\/$)/g,"");a=a+"/"+c.original.text;
c=c.original.icon;mongoRename(a,b,c);break;case "Confirm folder rename":b=$("#directoName").val();b=b.replace(/(^\/)|(\/$)/g,"");a=b.lastIndexOf("/");a=b.slice(0,a+1);a+=c.original.text;c=c.icon;mongoRename(a,b,c);break;case "Confirm moving":$.jstree.reference("#mongoTree");break;case "Confirm copying":$("#mongoTree").jstree(!0).get_json("#",{flat:!0});break;default:throw"Unknown command:"+a;}}
$("#btnLogInni").click(function(){var a=$("#mngUsrnm").val(),b=$("#mngPWD").val(),d={username:a,password:b};$.post("/login",d).done(function(a){if("Login successfull"==a.responseStr){userName=d.username;var b=a.token;window.sessionStorage.setItem("RTFuser",a.user.username);window.sessionStorage.setItem("RTFtoken",b);$.notifyBar({html:"You are now logged in as: "+userName});$("#frm-Login").hide();dirUser=userName;treeUpdate();$("#frm-FileTree").show();$("#btnLogMeOff").show();$("#btn-mngOpenSave").show();
$("#mngUsrnm").val("");$("#mngPWD").val("");$("#FilTreLege").text("Files on server in "+userName+"'s directory")}else userName="No login",dirUser="Publ",$.notifyBar({cssClass:"error",html:"Error in username and/or password, retry or hit Cancel"})}).fail(function(){userName="No login";dirUser="Publ";$.notifyBar({cssClass:"warning",html:"Unable to authenticate user (Connection or database error)"})});dirUser="No login"==userName?"Publ":userName});
var aTree=$("#mongoTree").jstree({core:{check_callback:!0},plugins:["contextmenu","wholerow","unique"],contextmenu:{items:function(a){a=$.jstree.defaults.contextmenu.items();a.create._disabled=!0;delete a.create;delete a.ccp;return a},select_node:!0}});$("#directoName, #mongoFileName").focus(function(){$("#btn-mngOpenSave").text("Save data")});
